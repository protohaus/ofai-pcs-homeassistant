substitutions:
  stepper_motor_id_upper: ${device_name_upper}.stepper
  stepper_motor_id: ${device_name}_stepper

esphome: 
  on_boot:
    priority: 799 # Highest priority, ensures enable pin to be turned off first
    then:
      - output.turn_on: ${stepper_motor_id}_enable_pin # set the enable pin to HIGH -> disables all motor functions
      - homeassistant.service:
          service: esphome.${stepper_motor_id_upper}_set_step_width
          data:
            step_width: '100'
      - homeassistant.service:
          service: esphome.${stepper_motor_id_upper}_set_speed
          data:
            speed: !lambda 'return id(current_speed);'           

# make sure the stepper does not run while the ota update is performed            
ota:
  on_begin:
    then:
      - button.press: ${stepper_motor_id}_stop  
      - switch.turn_off: ${stepper_motor_id}_enable_motor
      
output:
  - platform: gpio
    pin: ${stepper_enable_pin}
    id: ${stepper_motor_id}_enable_pin
    
stepper:
  - platform: a4988
    id: ${stepper_motor_id}
    step_pin: ${stepper_step_pin}
    dir_pin:
      number: ${stepper_dir_pin}
      inverted: ${stepper_invert_direction}  
    max_speed: "${stepper_max_speed} steps/s"

    sleep_pin: ${stepper_sleep_pin} 
    acceleration: ${stepper_acceleration}
    deceleration: ${stepper_deceleration}
      
globals:
  
  - id: motor_enabled
    type: bool
    restore_value: no
    initial_value: "false"  
    
  - id: endless_mode
    type: bool
    restore_value: no
    initial_value: "false"
    
  - id: direction_forward
    type: bool
    restore_value: no
    initial_value: "true"
    
  - id: full_turn_steps
    type: int
    restore_value: yes
    initial_value: ${stepper_initial_full_turn_steps}
    
  - id: target_position
    type: int
    restore_value: no
    initial_value: "0"
  
  - id: current_speed
    type: int
    restore_value: no
    initial_value: ${stepper_initial_speed}
  
  - id: current_acceleration
    type: int
    restore_value: no
    initial_value: ${stepper_acceleration}
  
  - id: current_deceleration
    type: int
    restore_value: no
    initial_value: ${stepper_deceleration}
    
  - id: step_width
    type: int
    restore_value: no
    initial_value: ${stepper_initial_step_width}

  #nonstop mode, motor drives in endless loop
  - id: stepper_mode
    type: int
    restore_value: no
    initial_value: "0" # 0: target-mode, 1: step-mode, 2: drive-mode, 3: 360-mode, 4: 1/6-mode, 5: homing-mode
   
sensor:
  - platform: template
    name: "${stepper_motor_id_upper}.position_now"
    id: ${stepper_motor_id}_position_now
    unit_of_measurement: "steps"
    state_class: "measurement"
    lambda: |-
      return id($stepper_motor_id).current_position;
    update_interval: 0.1s
    
  - platform: template
    name: "${stepper_motor_id_upper}.position_target"
    id: ${stepper_motor_id}_target_position
    unit_of_measurement: "steps"
    state_class: "measurement"
    lambda: |-
      return id(target_position);
    update_interval: 1s
    
  - platform: template
    name: "${stepper_motor_id_upper}.current_speed"
    id: ${stepper_motor_id}_current_speed
    unit_of_measurement: "steps/s"
    state_class: "measurement"
    lambda: |-
      return id(current_speed);
    update_interval: 1s
    
  - platform: template
    name: "${stepper_motor_id_upper}.current_acceleration"
    id: ${stepper_motor_id}_current_acceleration
    unit_of_measurement: "steps/s^2"
    state_class: "measurement"
    lambda: |-
      return id(current_acceleration);
    update_interval: 1s
    
  - platform: template
    name: "${stepper_motor_id_upper}.current_deceleration"
    id: ${stepper_motor_id}_current_deceleration
    unit_of_measurement: "steps/s^2"
    state_class: "measurement"
    lambda: |-
      return id(current_deceleration);
    update_interval: 1s
   
  - platform: template
    name: "${stepper_motor_id_upper}.step_width"
    id: ${stepper_motor_id}_step_width
    unit_of_measurement: "steps/s^2"
    state_class: "measurement"
    lambda: |-
      return id(step_width);
    update_interval: 1s   

binary_sensor:
  - platform: template
    name: "${stepper_motor_id_upper}.active"
    id: ${stepper_motor_id}_active
    lambda: |-
      if (id($stepper_motor_id).current_position != id($stepper_motor_id).target_position) 
      {
        // Motor is still moving
        return true;
      }else 
      {
        // Motor is at target position
        return false;
      }
      
  - platform: gpio
    name: ${device_name_upper}.diag_pin
    id: ${device_name}_diag_pin
    pin: 
      number: GPIO33
      mode:
        input: true
        pullup: true
      inverted: false
    
  - platform: gpio
    name: ${device_name_upper}.sleep_state_pin
    id: ${device_name}_sleep_state_pin
    pin:
      number: ${stepper_sleep_state_pin}
      mode:
        input: true
        pullup: true
      inverted: true
    on_press:
      then:
        - output.turn_on: ${stepper_motor_id}_enable_pin
    on_release:
        - output.turn_off: ${stepper_motor_id}_enable_pin
    
switch:
  - platform: template
    name: ${stepper_motor_id_upper}.enable_motor
    id: ${stepper_motor_id}_enable_motor
    lambda: |-
      if (id(motor_enabled) == true)
        return true;
      else
        return false;
    
    turn_on_action:
      - globals.set:
          id: motor_enabled
          value: "true"  
    turn_off_action:
      - globals.set:
          id: motor_enabled
          value: "false"
      - globals.set: 
          id: endless_mode
          value: "false"
      - button.press: ${stepper_motor_id}_stop    
    
button:
  - platform: template
    name: ${stepper_motor_id_upper}.start
    id: ${stepper_motor_id}_start
    on_press:
      - logger.log: "Start Motor"
      - stepper.set_target:
          id: ${stepper_motor_id}
          target: !lambda 'return (id(motor_enabled) == true) ? id(target_position) : id($stepper_motor_id).current_position;'
            
  - platform: template
    name: ${stepper_motor_id_upper}.stop
    id: ${stepper_motor_id}_stop
    on_press:
      - logger.log: "Stop Motor"
      - stepper.set_target:
            id: ${stepper_motor_id}
            target: !lambda 'return id($stepper_motor_id).current_position;' 
      - globals.set: 
          id: endless_mode
          value: "false"
        
  - platform: template
    name: ${stepper_motor_id_upper}.step_forward
    id: ${stepper_motor_id}_step_forward
    on_press:
      - globals.set: 
          id: target_position
          value: !lambda 'return id($stepper_motor_id).current_position + id(step_width);'   
      - button.press: ${stepper_motor_id}_start
      
  - platform: template
    name: ${stepper_motor_id_upper}.step_backward
    id: ${stepper_motor_id}_step_backward
    on_press:
      - globals.set: 
          id: target_position
          value: !lambda 'return id($stepper_motor_id).current_position - id(step_width);'   
      - button.press: ${stepper_motor_id}_start   
  
  - platform: template
    name: ${stepper_motor_id_upper}.set_zero_position
    id: ${stepper_motor_id}_set_zero_position
    on_press:
      - logger.log: "Set current position to zero"
      - button.press: ${stepper_motor_id}_stop
      - stepper.report_position:
          id: ${stepper_motor_id}
          position: 0 
      - globals.set: 
          id: target_position
          value: "0"
      - button.press: ${stepper_motor_id}_stop
    
  - platform: template
    name: ${stepper_motor_id_upper}.drive_forward
    id: ${stepper_motor_id}_drive_forward
    on_press:
      - globals.set:
          id: direction_forward
          value: "true"
      - globals.set: 
          id: target_position
          value: !lambda 'return id($stepper_motor_id).current_position + ${stepper_max_speed}*2;'  
      - globals.set: 
          id: endless_mode
          value: "true"
      - button.press: ${stepper_motor_id}_start
    
  - platform: template
    name: ${stepper_motor_id_upper}.drive_backward
    id: ${stepper_motor_id}_drive_backward
    on_press:
      - globals.set:
          id: direction_forward
          value: "false"
      - globals.set: 
          id: target_position
          value: !lambda 'return id($stepper_motor_id).current_position - ${stepper_max_speed}*2;'  
      - globals.set: 
          id: endless_mode
          value: "true"
      - button.press: ${stepper_motor_id}_start
      
interval:
  - interval: 1s
    then:
      if:
        condition:
          lambda: |-
            return id(endless_mode) == true;
        then:
          - globals.set: 
              id: target_position
              value: !lambda 'return (id($stepper_motor_id).current_position + (id(direction_forward) == true ? 1 : -1) *  id(current_speed)*1.5);'        
          - button.press: ${stepper_motor_id}_start

api:
  services:      
    - service: stepper_set_absolute_target
      variables:
        target: int
      then:
        - logger.log: "Set stepper absolute target value"
        - globals.set: 
            id: target_position
            value: !lambda 'return target;' 
        - button.press: ${stepper_motor_id}_start 
            
    - service: stepper_set_step_width
      variables:
        step_width: int
      then:
        - logger.log: "Set stepper step width"
        - globals.set: 
            id: step_width
            value: !lambda 'return step_width;' 
            
    - service: stepper_set_speed
      variables:
        speed: int
      then:
        - logger.log: "Set stepper speed"
        - stepper.set_speed:
            id: ${stepper_motor_id}
            speed: !lambda 'return speed;'  
        - globals.set: 
            id: current_speed
            value: !lambda 'return speed;' 
            
    - service: stepper_set_acceleration
      variables:
        acceleration: int
      then:
        - logger.log: "Set stepper acceleration"
        - stepper.set_acceleration:
            id: ${stepper_motor_id}
            acceleration: !lambda 'return acceleration;' 
        - globals.set: 
            id: current_acceleration
            value: !lambda 'return acceleration;' 
            
    - service: stepper_set_deceleration
      variables:
        deceleration: int
      then:
        - logger.log: "Set stepper deceleration"
        - stepper.set_deceleration:
            id: ${stepper_motor_id}
            deceleration: !lambda 'return deceleration;'  
        - globals.set: 
            id: current_deceleration
            value: !lambda 'return deceleration;' 